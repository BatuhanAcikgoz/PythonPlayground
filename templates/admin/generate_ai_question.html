<!DOCTYPE html>
<html>
<head>
    <title>Yapay Zeka ile Soru Oluştur - Admin Panel</title>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <!-- CodeMirror for code editing -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <!-- Markdown Editor -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        html, body, #root {
            height: 100%;
        }
        #root {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .CodeMirror {
            height: auto;
            min-height: 200px;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
        }

        /* Dark mode için CodeMirror stilleri */
        .dark .CodeMirror {
            border-color: #4b5563;
        }

        /* Dark mode için markdown önizleme stilleri */
        .dark .prose {
            color: #e5e7eb;
        }
        .dark .prose h1, .dark .prose h2, .dark .prose h3,
        .dark .prose h4, .dark .prose h5, .dark .prose h6 {
            color: #f3f4f6;
        }
        .dark .prose p, .dark .prose li {
            color: #d1d5db;
        }
        .dark .prose code {
            background-color: #374151;
            color: #e5e7eb;
        }
        .dark .prose pre {
            background-color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <div id="root"></div>

    <script>
        window.APP_DATA = {
            isLoggedIn: {{ current_user.is_authenticated|tojson }},
            isAdmin: {{ 'true' if current_user.is_authenticated and current_user.is_admin() else 'false' }},
            userData: {
                username: {{ current_user.username|tojson if current_user.is_authenticated else 'null'|safe }},
                email: {{ current_user.email|tojson if current_user.is_authenticated else 'null'|safe }}
            },
            headerTrans: {
                appName: {{ _('app_name')|tojson|safe }},
                tagline: {{ _('app_tagline')|tojson|safe }},
                home: {{ _('home')|tojson|safe }},
                questions: {{ _('questions')|tojson|safe }},
                leaderboard: {{ _('leaderboard')|tojson|safe }},
                about: {{ _('about')|tojson|safe }},
                logout: {{ _('logout')|tojson|safe }},
                login: {{ _('login')|tojson|safe }},
                register: {{ _('register')|tojson|safe }},
                profile: {{ _('profile')|tojson|safe }},
                settings: {{ _('settings')|tojson|safe }}
            },
            formData: {
                csrf_token: "{{ csrf_token() }}"
            },
            footerTrans: {
                allRights: {{ _('all_rights')|tojson|safe }},
                platformDesc: {{ _('platform_desc')|tojson|safe }}
            },
            currentLang: {{ session.get('language', 'tr')|tojson }}
        };
    </script>

    <script type="text/babel" src="{{ url_for('main.serve_component', filename='ThemeContext.js') }}"></script>
    <script type="text/babel" src="{{ url_for('main.serve_component', filename='Header.jsx') }}"></script>
    <script type="text/babel" src="{{ url_for('main.serve_component', filename='Footer.jsx') }}"></script>
    <script type="text/babel" src="{{ url_for('main.serve_component', filename='AdminSidebar.jsx') }}"></script>

    <script type="text/babel">
        const FormField = ({ label, id, error, children, hint }) => {
            return (
                <div className="mb-5">
                    <label htmlFor={id} className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{label}</label>
                    {children}
                    {hint && <div className="mt-1 text-xs text-gray-500 dark:text-gray-400">{hint}</div>}
                    {error && <p className="mt-1 text-sm text-red-600 dark:text-red-400">{error}</p>}
                </div>
            );
        };

        const CodeEditor = ({ id, name, value, onChange }) => {
            const textareaRef = React.useRef(null);
            const editorRef = React.useRef(null);
            const { darkMode } = window.useTheme();

            React.useEffect(() => {
                if (textareaRef.current && !editorRef.current) {
                    editorRef.current = CodeMirror.fromTextArea(textareaRef.current, {
                        mode: "python",
                        lineNumbers: true,
                        indentUnit: 4,
                        lineWrapping: true,
                        theme: darkMode ? "dracula" : "default"
                    });

                    editorRef.current.on('change', (instance) => {
                        const value = instance.getValue();
                        if (onChange) onChange(value);
                    });
                }

                return () => {
                    if (editorRef.current) {
                        editorRef.current.toTextArea();
                        editorRef.current = null;
                    }
                };
            }, []);

            // Dark mode değiştiğinde tema güncellenir
            React.useEffect(() => {
                if (editorRef.current) {
                    editorRef.current.setOption("theme", darkMode ? "dracula" : "default");
                }
            }, [darkMode]);

            React.useEffect(() => {
                if (editorRef.current && value !== undefined) {
                    const currentValue = editorRef.current.getValue();
                    if (value !== currentValue) {
                        editorRef.current.setValue(value);
                    }
                }
            }, [value]);

            return (
                <textarea
                    ref={textareaRef}
                    id={id}
                    name={name}
                    defaultValue={value || ''}
                    className="hidden"
                />
            );
        };

        const AIQuestionGenerator = () => {
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [generatedQuestion, setGeneratedQuestion] = React.useState(null);
            const [savedSuccess, setSavedSuccess] = React.useState(false);
            const editorRef = React.useRef(null);
            const { darkMode } = window.useTheme();

            // forceUpdate için basit bir reducer ekleyin yeniden render için
            const [, forceUpdate] = React.useReducer(x => x + 1, 0);

            const [formData, setFormData] = React.useState({
                difficulty_level: 1,
                topic: "genel",
                description_hint: "",
                function_name_hint: "",
                tags: []
            });

            const [questionData, setQuestionData] = React.useState({
                id: null,
                title: "",
                description: "",
                function_name: "",
                difficulty: 1,
                topic: "",
                points: 10,
                example_input: "",
                example_output: "",
                test_inputs: "[]",
                solution_code: ""
            });

            // JSON string doğrulama ve düzeltme fonksiyonu
            const validateAndFixJSON = (jsonString, defaultValue = "[]") => {
                try {
                    // Önce JSON'ı ayrıştırmayı dene
                    JSON.parse(jsonString);
                    return jsonString; // Geçerliyse aynısını döndür
                } catch (e) {
                    console.error("Geçersiz JSON formatı, düzeltmeye çalışılıyor:", jsonString);

                    try {
                        // Eksik parantezleri otomatik olarak tamamlamaya çalış
                        let fixedJson = jsonString.trim();

                        // İç diziler için kapanış parantezi kontrolü
                        const openBrackets = (fixedJson.match(/\[/g) || []).length;
                        const closeBrackets = (fixedJson.match(/\]/g) || []).length;

                        // Eksik kapanış parantezlerini ekle
                        if (openBrackets > closeBrackets) {
                            for (let i = 0; i < openBrackets - closeBrackets; i++) {
                                fixedJson += ']';
                            }
                        }

                        // Özel durum: Yarım kalmış iç dizi
                        if (fixedJson.match(/\[\s*\[\s*.*[^\]]\s*$/)) {
                            fixedJson += ']';
                        }

                        // Kontrol et
                        JSON.parse(fixedJson);
                        console.log("JSON düzeltildi:", fixedJson);
                        return fixedJson;
                    } catch (e2) {
                        console.error("JSON düzeltme başarısız:", e2);

                        // Daha detaylı düzeltme girişimi
                        try {
                            // Dizinin başlangıcını ve sonunu düzelt
                            let fixedJson = jsonString.trim();
                            if (!fixedJson.startsWith('[')) fixedJson = '[' + fixedJson;
                            if (!fixedJson.endsWith(']')) fixedJson += ']';

                            // İç içe diziyi düzelt
                            fixedJson = fixedJson.replace(/\[([^\[\]]*?)(?!\])$/, '[$1]');

                            // Kontrol et
                            JSON.parse(fixedJson);
                            return fixedJson;
                        } catch (e3) {
                            console.error("Detaylı JSON düzeltme de başarısız:", e3);
                            return defaultValue;
                        }
                    }
                }
            };

            const topics = [
                { value: "genel", label: "Genel (Rastgele)" },
                { value: "veri yapıları", label: "Veri Yapıları" },
                { value: "algoritmalar", label: "Algoritmalar" },
                { value: "string işleme", label: "String İşleme" },
                { value: "matematik", label: "Matematik" },
                { value: "sayı teorisi", label: "Sayı Teorisi" },
                { value: "istatistik", label: "İstatistik" },
                { value: "veri bilimi", label: "Veri Bilimi" },
                { value: "sıralama", label: "Sıralama" },
                { value: "dinamik programlama", label: "Dinamik Programlama" },
                { value: "graf teorisi", label: "Graf Teorisi" },
                { value: "arama algoritmaları", label: "Arama Algoritmaları" },
                { value: "matris işlemleri", label: "Matris İşlemleri" },
                { value: "kombinatorik", label: "Kombinatorik" },
                { value: "bit manipülasyonu", label: "Bit Manipülasyonu" },
                { value: "dosya işlemleri", label: "Dosya İşlemleri" }
            ];

            const availableTags = [
                "python", "algoritma", "programlama", "veri yapıları", "string", "liste",
                "dizi", "sözlük", "recursion", "özyineleme", "matematik", "sayılar"
            ];

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData({
                    ...formData,
                    [name]: value
                });
            };

            const handleTagToggle = (tag) => {
                setFormData(prevState => {
                    const currentTags = [...prevState.tags];
                    if (currentTags.includes(tag)) {
                        return {
                            ...prevState,
                            tags: currentTags.filter(t => t !== tag)
                        };
                    } else {
                        return {
                            ...prevState,
                            tags: [...currentTags, tag]
                        };
                    }
                });
            };

            const handleQuestionDataChange = (e) => {
                const { name, value } = e.target;
                setQuestionData({
                    ...questionData,
                    [name]: value
                });
            };

            const handleCodeChange = (value) => {
                setQuestionData({
                    ...questionData,
                    solution_code: value
                });
            };

            // generatedQuestion değiştiğinde tetiklenecek useEffect
            React.useEffect(() => {
                if (generatedQuestion) {
                    console.log("generatedQuestion değişti:", generatedQuestion);
                    setQuestionData(generatedQuestion);

                    // Zorla form alanlarını güncelle
                    setTimeout(() => {
                        Object.keys(generatedQuestion).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                if (element.tagName === 'SELECT') {
                                    element.value = generatedQuestion[key];
                                } else if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
                                    element.value = generatedQuestion[key];
                                }
                            }
                        });

                        // CodeMirror için özel güncelleme
                        if (editorRef && editorRef.current) {
                            editorRef.current.setValue(generatedQuestion.solution_code || "");
                        }

                        forceUpdate(); // Zorla yeniden render
                    }, 200);
                }
            }, [generatedQuestion]);

            // Soru oluşturma API isteği
            const generateQuestion = async () => {
                setLoading(true);
                setError(null);

                try {
                    // Form verilerini React state'inden kullan
                    const requestData = {
                        difficulty_level: parseInt(formData.difficulty_level),
                        topic: formData.topic,
                        description_hint: formData.description_hint,
                        function_name_hint: formData.function_name_hint,
                        tags: formData.tags
                    };

                    const response = await fetch('/api/generate-question', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': APP_DATA.formData.csrf_token
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`API hatası: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.error) {
                        setError(data.error);
                    } else {
                        // Test inputs JSON'ını doğrula ve düzelt
                        const fixedTestInputs = validateAndFixJSON(data.test_inputs || "[]");
                        console.log("Düzeltilmiş test girdileri:", fixedTestInputs);

                        // Önce questionData'yı doğrudan güncelle
                        const newQuestionData = {
                            title: data.title || "",
                            description: data.description || "",
                            function_name: data.function_name || "",
                            difficulty: data.difficulty || 1,
                            topic: data.topic || "",
                            points: data.points || 10,
                            example_input: data.example_input || "Örnek girdi yok",
                            example_output: data.example_output || "Örnek çıktı yok",
                            test_inputs: fixedTestInputs,
                            solution_code: data.solution_code || ""
                        };

                        setQuestionData(newQuestionData); // Önce questionData'yı güncelle
                        setGeneratedQuestion(newQuestionData); // Sonra generatedQuestion'ı güncelle

                        // Zorla form alanlarını güncelle
                        setTimeout(() => {
                            const inputs = document.querySelectorAll('input, textarea, select');
                            inputs.forEach(input => {
                                if (newQuestionData[input.name]) {
                                    input.value = newQuestionData[input.name];
                                }
                            });
                        }, 100);
                    }
                } catch (err) {
                    setError("Soru oluşturulurken bir hata oluştu: " + err.message);
                    console.error("Soru oluşturma hatası:", err);
                } finally {
                    setLoading(false);
                    setTimeout(() => forceUpdate(), 300); // Zorla yeniden render
                }
            };

            const saveQuestion = async () => {
                setLoading(true);
                setError(null);

                try {
                    // Test inputs formatını kontrol et ve düzelt
                    let validTestInputs = questionData.test_inputs;
                    try {
                        JSON.parse(questionData.test_inputs);
                    } catch (e) {
                        validTestInputs = validateAndFixJSON(questionData.test_inputs, "[[]]");

                        // State'i güncelle ki kullanıcı düzeltilmiş versiyonu görebilsin
                        setQuestionData(prev => ({
                            ...prev,
                            test_inputs: validTestInputs
                        }));

                        // Yeniden render için
                        forceUpdate();
                    }

                    // saveQuestion fonksiyonunda endpoint değişikliği yapalım
                    const response = await fetch('/api/save-question', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': APP_DATA.formData.csrf_token
                        },
                        signal: AbortSignal.timeout(100000), // 100 saniye timeout
                        body: JSON.stringify({
                            ...questionData,
                            test_inputs: validTestInputs
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API hatası: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.error) {
                        setError(data.error);
                    } else {
                        if (data.id) {
                            setQuestionData(prevData => ({
                                ...prevData,
                                id: data.id
                            }));
                        }
                        setSavedSuccess(true);
                        // 3 saniye sonra başarı mesajını kaldır
                        setTimeout(() => {
                            setSavedSuccess(false);
                        }, 3000);
                    }
                } catch (err) {
                    setError("Kaydetme sırasında bir hata oluştu: " + err.message);
                    console.error("Kaydetme hatası:", err);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6">
                    {!generatedQuestion ? (
                        // Soru oluşturma formu
                        <div>
                            <h2 className="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Yapay Zeka ile Soru Oluştur</h2>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <FormField label="Zorluk Seviyesi" id="difficulty_level">
                                    <select
                                        id="difficulty_level"
                                        name="difficulty_level"
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                        value={formData.difficulty_level}
                                        onChange={handleChange}
                                    >
                                        <option value="1">Kolay (1)</option>
                                        <option value="2">Orta (2)</option>
                                        <option value="3">Zor (3)</option>
                                        <option value="4">Çok Zor (4)</option>
                                    </select>
                                </FormField>

                                <FormField label="Konu" id="topic">
                                    <select
                                        id="topic"
                                        name="topic"
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                        value={formData.topic}
                                        onChange={handleChange}
                                    >
                                        {topics.map(topic => (
                                            <option key={topic.value} value={topic.value}>{topic.label}</option>
                                        ))}
                                    </select>
                                </FormField>
                            </div>

                            <FormField label="Soru İpucu (İsteğe Bağlı)" id="description_hint"
                                       hint="Sorunun ne hakkında olması gerektiğini belirtin. Örn: 'Bir diziyi sırala ve ortadaki elemanı bul'">
                                <textarea
                                    id="description_hint"
                                    name="description_hint"
                                    rows="3"
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                    value={formData.description_hint}
                                    onChange={handleChange}
                                ></textarea>
                            </FormField>

                            <FormField label="Fonksiyon Adı Önerisi (İsteğe Bağlı)" id="function_name_hint"
                                       hint="Çözüm fonksiyonunun adını belirtin. Örn: 'max_subarray_sum'">
                                <input
                                    type="text"
                                    id="function_name_hint"
                                    name="function_name_hint"
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                    value={formData.function_name_hint}
                                    onChange={handleChange}
                                />
                            </FormField>

                            <FormField label="Etiketler (İsteğe Bağlı)" id="tags" hint="Soru ile ilgili etiketleri seçin">
                                <div className="flex flex-wrap gap-2">
                                    {availableTags.map(tag => (
                                        <button
                                            key={tag}
                                            type="button"
                                            className={`px-3 py-1 rounded-full text-sm ${
                                                formData.tags.includes(tag)
                                                    ? 'bg-blue-500 text-white'
                                                    : 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'
                                            }`}
                                            onClick={() => handleTagToggle(tag)}
                                        >
                                            {tag}
                                        </button>
                                    ))}
                                </div>
                            </FormField>

                            {error && (
                                <div className="mb-4 p-3 bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-800 text-red-700 dark:text-red-300 rounded-md">
                                    <p className="font-medium">Hata!</p>
                                    <p>{error}</p>
                                </div>
                            )}

                            <div className="mt-6">
                                <button
                                    type="button"
                                    className="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md"
                                    onClick={generateQuestion}
                                    disabled={loading}
                                >
                                    {loading ? "Soru Üretiliyor..." : "Yapay Zeka ile Soru Oluştur"}
                                </button>
                            </div>
                        </div>
                    ) : (
                        // Oluşturulan soruyu düzenleme formu
                        <div>
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-semibold text-gray-800 dark:text-white">Oluşturulan Soru</h2>
                                <button
                                    type="button"
                                    className="px-4 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-md"
                                    onClick={() => setGeneratedQuestion(null)}
                                >
                                    Yeni Soru Oluştur
                                </button>
                            </div>

                            <FormField label="Soru Başlığı" id="title">
                                <input
                                    type="text"
                                    id="title"
                                    name="title"
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                    value={questionData.title}
                                    onChange={handleQuestionDataChange}
                                    required
                                />
                            </FormField>

                            <FormField label="Soru Açıklaması (Markdown destekler)" id="description">
                                <textarea
                                    id="description"
                                    name="description"
                                    rows="6"
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                    value={questionData.description}
                                    onChange={handleQuestionDataChange}
                                    required
                                ></textarea>
                            </FormField>

                            {% raw %}
                            <div className="my-4">
                                <h3 className="font-medium mb-2 text-gray-700 dark:text-gray-300">Önizleme:</h3>
                                <div className="p-4 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 prose max-w-none"
                                     dangerouslySetInnerHTML={{ __html: marked.parse(questionData.description) }}>
                                </div>
                            </div>
                            {% endraw %}

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                                <FormField label="Zorluk Seviyesi" id="difficulty">
                                    <select
                                        id="difficulty"
                                        name="difficulty"
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                        value={questionData.difficulty}
                                        onChange={handleQuestionDataChange}
                                        required
                                    >
                                        <option value="1">Kolay (1)</option>
                                        <option value="2">Orta (2)</option>
                                        <option value="3">Zor (3)</option>
                                        <option value="4">Çok Zor (4)</option>
                                    </select>
                                </FormField>

                                <FormField label="Konu" id="topic">
                                    <input
                                        type="text"
                                        id="topic"
                                        name="topic"
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                        value={questionData.topic}
                                        onChange={handleQuestionDataChange}
                                        required
                                    />
                                </FormField>

                                <FormField label="Puan Değeri" id="points">
                                    <input
                                        type="number"
                                        id="points"
                                        name="points"
                                        min="1"
                                        max="100"
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                        value={questionData.points}
                                        onChange={handleQuestionDataChange}
                                        required
                                    />
                                </FormField>

                                <FormField label="Fonksiyon Adı" id="function_name">
                                    <input
                                        type="text"
                                        id="function_name"
                                        name="function_name"
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                        value={questionData.function_name}
                                        onChange={handleQuestionDataChange}
                                        required
                                    />
                                </FormField>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                                <FormField label="Örnek Girdi" id="example_input">
                                    <textarea
                                        id="example_input"
                                        name="example_input"
                                        rows="3"
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                        value={questionData.example_input}
                                        onChange={handleQuestionDataChange}
                                        required
                                    ></textarea>
                                </FormField>

                                <FormField label="Örnek Çıktı" id="example_output">
                                    <textarea
                                        id="example_output"
                                        name="example_output"
                                        rows="3"
                                        className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                        value={questionData.example_output}
                                        onChange={handleQuestionDataChange}
                                        required
                                    ></textarea>
                                </FormField>
                            </div>

                            <FormField label="Çözüm Kodu (Python)" id="solution_code">
                                <div className="mb-1 text-xs text-gray-600 dark:text-gray-400">
                                    Öğrencilerin görevi tamamlaması için gereken Python kodu
                                </div>
                                <CodeEditor
                                    id="solution_code"
                                    name="solution_code"
                                    value={questionData.solution_code}
                                    onChange={handleCodeChange}
                                />
                            </FormField>

                            <FormField label="Test Girdileri (JSON)" id="test_inputs">
                                <div className="mb-1 text-xs text-gray-600 dark:text-gray-400">
                                    Test girdilerini JSON formatında belirtin. Örnek: '[
    [1, 2, 3],
    [5, 3],
    [10, 20],
    [0, 0]
]'
                                </div>
                                <textarea
                                    id="test_inputs"
                                    name="test_inputs"
                                    rows="5"
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                    value={questionData.test_inputs}
                                    onChange={handleQuestionDataChange}
                                    required
                                ></textarea>
                            </FormField>

                            {error && (
                                <div className="mb-4 p-3 bg-red-100 dark:bg-red-900/30 border border-red-300 dark:border-red-800 text-red-700 dark:text-red-300 rounded-md">
                                    <p className="font-medium">Hata!</p>
                                    <p>{error}</p>
                                </div>
                            )}

                            {savedSuccess && (
                                <div className="mb-4 p-3 bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-800 text-green-700 dark:text-green-300 rounded-md">
                                    <p className="font-medium">Başarılı!</p>
                                    <p>Soru başarıyla kaydedildi.</p>
                                </div>
                            )}

                            <div className="flex justify-between mt-8">
                                <a href="{{ url_for('admin.programming_questions') }}" className="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md">İptal</a>
                                <button
                                    type="button"
                                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md"
                                    onClick={saveQuestion}
                                    disabled={loading}
                                >
                                    {loading ? "Kaydediliyor..." : "Soruyu Kaydet"}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const { darkMode } = window.useTheme(); // Tema durumunu al

            return (
                <React.Fragment>
                    <Header />
                    <div className="flex flex-grow">
                        <AdminSidebar />

                        <main className={`flex-grow p-6 ${darkMode ? "bg-gray-900 text-white" : "bg-gray-50 text-black"}`}>
                            <div className="container mx-auto max-w-6xl">
                                <h1 className="text-2xl font-bold mb-6 dark:text-white">Yapay Zeka ile Soru Oluştur</h1>

                                <AIQuestionGenerator />
                            </div>
                        </main>
                    </div>
                    <Footer />
                </React.Fragment>
            );
        };

        ReactDOM.render(
            <window.ThemeProvider>
                <App />
            </window.ThemeProvider>,
            document.getElementById('root')
        );
    </script>
        <!-- Flash mesajları için script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    const container = document.querySelector('.container');
                    const formElement = document.querySelector('form');

                    {% for category, message in messages %}
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `p-4 mb-4 rounded-lg ${category === 'success' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300'}`;
                        messageDiv.textContent = '{{ message }}';
                        container.insertBefore(messageDiv, formElement);
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>
</body>
</html>