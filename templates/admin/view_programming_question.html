<!DOCTYPE html>
<html>
<head>
    <title>{{ question.title }} - Admin Panel</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- DOMPurify for HTML sanitization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.1/purify.min.js"></script>
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <!-- Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <style>
        html, body, #root {
            height: 100%;
        }
        #root {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .code-block {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
            overflow-x: auto;
        }
        .markdown-content pre {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            overflow-x: auto;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .markdown-content p {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content ul, .markdown-content ol {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            margin-left: 1.5rem;
        }
        .markdown-content ul {
            list-style-type: disc;
        }
        .markdown-content ol {
            list-style-type: decimal;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- Define global variables for component access -->
    <script>
        window.APP_DATA = {
            isLoggedIn: {{ current_user.is_authenticated|tojson }},
            userData: {
                username: {{ current_user.username|tojson if current_user.is_authenticated else 'null'|safe }},
                email: {{ current_user.email|tojson if current_user.is_authenticated else 'null'|safe }}
            },
            currentLang: {{ session.get('language', 'tr')|tojson }},
            // Header translations
            headerTrans: {
                appName: {{ _('app_name')|tojson|safe }},
                tagline: {{ _('app_tagline')|tojson|safe }},
                home: {{ _('home')|tojson|safe }},
                questions: {{ _('questions')|tojson|safe }},
                leaderboard: {{ _('leaderboard')|tojson|safe }},
                about: {{ _('about')|tojson|safe }},
                logout: {{ _('logout')|tojson|safe }},
                login: {{ _('login')|tojson|safe }},
                register: {{ _('register')|tojson|safe }},
                profile: {{ _('profile')|tojson|safe }},
                settings: {{ _('settings')|tojson|safe }}
            },
            footerTrans: {
                allRights: {{ _('all_rights')|tojson|safe }},
                platformDesc: {{ _('platform_desc')|tojson|safe }}
            },
            // Language translations
            translations: {
                edit: {{ _('edit')|tojson|safe }} || "Düzenle",
                delete: {{ _('delete')|tojson|safe }} || "Sil",
                test: {{ _('test')|tojson|safe }} || "Test Et",
                difficulty: {{ _('difficulty')|tojson|safe }} || "Zorluk",
                points: {{ _('points')|tojson|safe }} || "Puanlar",
                description: {{ _('description')|tojson|safe }} || "Açıklama",
                example_input: {{ _('example_input')|tojson|safe }} || "Örnek Girdi",
                example_output: {{ _('example_output')|tojson|safe }} || "Örnek Çıktı",
                function_name: {{ _('function_name')|tojson|safe }} || "Fonksiyon Adı",
                solution_code: {{ _('solution_code')|tojson|safe }} || "Çözüm Kodu",
                test_inputs: {{ _('test_inputs')|tojson|safe }} || "Test Girdileri",
                submissions: {{ _('submissions')|tojson|safe }} || "Gönderimler",
                back_to_questions: {{ _('back_to_questions')|tojson|safe }} || "Sorulara Dön",
                delete_confirm: {{ _('delete_confirm')|tojson|safe }} || "Bu soruyu silmek istediğinize emin misiniz?",
                yes: {{ _('yes')|tojson|safe }} || "Evet",
                no: {{ _('no')|tojson|safe }} || "Hayır"
            },
            question: {
                id: {{ question.id }},
                title: {{ question.title|tojson|safe }},
                description: {{ question.description|tojson|safe }},
                difficulty: {{ question.difficulty }},
                points: {{ question.points }},
                function_name: {{ question.function_name|tojson|safe }},
                example_input: {{ question.example_input|tojson|safe }},
                example_output: {{ question.example_output|tojson|safe }},
                solution_code: {{ question.solution_code|tojson|safe }},
                test_inputs: {{ question.test_inputs|tojson|safe }},
                created_at: {{ question.created_at|tojson|safe }},
                updated_at: {{ question.updated_at|tojson|safe if question.updated_at else 'null'|safe }}
            },
            urls: {
                adminIndex: "{{ url_for('admin.index') }}",
                programmingQuestions: "{{ url_for('admin.programming_questions') }}",
                newProgrammingQuestion: "{{ url_for('admin.new_programming_question') }}",
                viewQuestion: "{{ url_for('admin.view_programming_question', id=0) }}",
                editQuestion: "{{ url_for('admin.edit_programming_question', id=0) }}",
                testQuestion: "{{ url_for('admin.test_programming_question', id=0) }}",
                deleteQuestion: "{{ url_for('admin.delete_programming_question', id=0) }}",
                questionSubmissions: "{{ url_for('admin.question_submissions', id=0) }}",
                users: "{{ url_for('admin.users') }}",
                badges: "{{ url_for('admin.badges') }}",
                newBadge: "{{ url_for('admin.new_badge') }}",
                editBadge: "{{ url_for('admin.edit_badge', id=0) }}",
                deleteBadge: "{{ url_for('admin.delete_badge', id=0) }}",
                settings: "{{ url_for('admin.settings') }}",
                leaderboard: "{{ url_for('main.leaderboard') }}"
            }
        };
    </script>

    <!-- Load component scripts -->
    <script type="text/babel" src="{{ url_for('main.serve_component', filename='Header.jsx') }}"></script>
    <script type="text/babel" src="{{ url_for('main.serve_component', filename='Footer.jsx') }}"></script>
    <script type="text/babel" src="{{ url_for('main.serve_component', filename='AdminSidebar.jsx') }}"></script>

    <script type="text/babel">
        {% raw %}
        const DifficultyBadge = ({ level }) => {
            const levels = {
                1: { text: 'Kolay', color: 'bg-green-100 text-green-800' },
                2: { text: 'Orta', color: 'bg-yellow-100 text-yellow-800' },
                3: { text: 'Zor', color: 'bg-orange-100 text-orange-800' },
                4: { text: 'Çok Zor', color: 'bg-red-100 text-red-800' }
            };

            const { text, color } = levels[level] || { text: 'Bilinmiyor', color: 'bg-gray-100 text-gray-800' };

            return (
                <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${color}`}>
                    {text}
                </span>
            );
        };

        const CodeBlock = ({ code, language }) => {
            const highlightedCode = React.useMemo(() => {
                return hljs.highlight(code, {language: language || 'python'}).value;
            }, [code, language]);

            return (
                <div className="code-block mb-4">
                    <pre>
                        <code dangerouslySetInnerHTML={{ __html: highlightedCode }} />
                    </pre>
                </div>
            );
        };

        const ProgrammingQuestion = ({ question }) => {
            const { translations } = window.APP_DATA;
            const [showDeleteConfirm, setShowDeleteConfirm] = React.useState(false);

            const renderDescription = () => {
                return { __html: DOMPurify.sanitize(marked.parse(question.description)) };
            };

            let testInputs;
            try {
                testInputs = JSON.parse(question.test_inputs);
            } catch (e) {
                testInputs = [];
                console.error("Failed to parse test inputs JSON", e);
            }
            const formattedTestInputs = JSON.stringify(testInputs, null, 2);

            return (
                <div className="container mx-auto max-w-8xl p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold">{question.title}</h1>
                        <div className="flex space-x-2">
                            <a href={window.APP_DATA.urls.programmingQuestions} className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                                {translations.back_to_questions}
                            </a>
                        </div>
                    </div>

                    <div className="bg-white shadow-md rounded-lg p-6 mb-6">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center space-x-4">
                                <span className="text-gray-700">{translations.difficulty}: <DifficultyBadge level={question.difficulty} /></span>
                                <span className="text-gray-700">{translations.points}: {question.points}</span>
                            </div>
                            <div className="flex space-x-2">
                                <a
                                    href={window.APP_DATA.urls.editQuestion.replace('0', question.id)}
                                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                >
                                    {translations.edit}
                                </a>
                                <a
                                    href={window.APP_DATA.urls.testQuestion.replace('0', question.id)}
                                    className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                                >
                                    {translations.test}
                                </a>
                                <a
                                    href={window.APP_DATA.urls.questionSubmissions.replace('0', question.id)}
                                    className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700"
                                >
                                    {translations.submissions}
                                </a>
                                <button
                                    onClick={() => setShowDeleteConfirm(true)}
                                    className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                                >
                                    {translations.delete}
                                </button>
                            </div>
                        </div>

                        <hr className="my-4" />

                        <h3 className="text-xl font-semibold mb-3">{translations.description}</h3>
                        <div className="markdown-content mb-6" dangerouslySetInnerHTML={renderDescription()}></div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 className="text-lg font-semibold mb-2">{translations.example_input}</h3>
                                <pre className="bg-gray-50 p-3 rounded-md">{question.example_input}</pre>
                            </div>
                            <div>
                                <h3 className="text-lg font-semibold mb-2">{translations.example_output}</h3>
                                <pre className="bg-gray-50 p-3 rounded-md">{question.example_output}</pre>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white shadow-md rounded-lg p-6 mb-6">
                        <div className="mb-4">
                            <h3 className="text-xl font-semibold mb-2">{translations.function_name}</h3>
                            <div className="bg-gray-50 p-3 rounded-md font-mono">{question.function_name}</div>
                        </div>

                        <div className="mb-6">
                            <h3 className="text-xl font-semibold mb-2">{translations.solution_code}</h3>
                            <CodeBlock code={question.solution_code} language="python" />
                        </div>

                        <div>
                            <h3 className="text-xl font-semibold mb-2">{translations.test_inputs}</h3>
                            <CodeBlock code={formattedTestInputs} language="json" />
                        </div>
                    </div>

                    {/* Delete Confirmation Modal */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                                <h3 className="text-xl font-bold mb-4">{translations.delete_confirm}</h3>
                                <p className="mb-6 text-gray-700">
                                    {question.title}
                                </p>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                                        onClick={() => setShowDeleteConfirm(false)}
                                    >
                                        {translations.no}
                                    </button>
                                    <form
                                        method="post"
                                        action={window.APP_DATA.urls.deleteQuestion.replace('0', question.id)}
                                        className="inline"
                                    >
                                        <button
                                            type="submit"
                                            className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                                        >
                                            {translations.yes}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            return (
                <React.Fragment>
                    <Header />
                    <div className="flex flex-grow">
                        <AdminSidebar />
                        <main className="flex-grow bg-gray-50 p-6">
                            <ProgrammingQuestion question={window.APP_DATA.question} />
                        </main>
                    </div>
                    <Footer />
                </React.Fragment>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
        {% endraw %}
    </script>
</body>
</html>