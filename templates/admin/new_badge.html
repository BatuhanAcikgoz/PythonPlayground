<!DOCTYPE html>
<html>
<head>
    <title>{{ _('new_badge') }} - {{ _('admin_panel') }}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        html, body, #root {
            height: 100%;
        }
        #root {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .emoji-list {
            max-height: 300px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
        }
        .emoji {
            font-size: 24px;
            line-height: 1;
        }
        .emoji-lg {
            font-size: 32px;
            line-height: 1;
        }
        .emoji-categories {
            display: flex;
            overflow-x: auto;
            padding: 8px 0;
            gap: 8px;
            margin-bottom: 8px;
        }
        .emoji-category {
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- Define global variables for component access -->
    <script>
        window.APP_DATA = {
            isLoggedIn: {{ current_user.is_authenticated|tojson }},
            userData: {
                username: {{ current_user.username|tojson if current_user.is_authenticated else 'null'|safe }},
                email: {{ current_user.email|tojson if current_user.is_authenticated else 'null'|safe }}
            },
            headerTrans: {
                appName: {{ _('app_name')|tojson|safe }},
                tagline: {{ _('app_tagline')|tojson|safe }},
                home: {{ _('home')|tojson|safe }},
                questions: {{ _('questions')|tojson|safe }},
                leaderboard: {{ _('leaderboard')|tojson|safe }},
                about: {{ _('about')|tojson|safe }},
                logout: {{ _('logout')|tojson|safe }},
                login: {{ _('login')|tojson|safe }},
                register: {{ _('register')|tojson|safe }},
                profile: "Profile",
                settings: "Settings"
            },
            footerTrans: {
                allRights: {{ _('all_rights')|tojson|safe }},
                platformDesc: {{ _('platform_desc')|tojson|safe }}
            },
            currentLang: {{ session.get('language', 'tr')|tojson }},
            formCsrfToken: "{{ form.csrf_token._value() }}",
            // URL'leri url_for ile tanÄ±mlÄ±yoruz
            urls: {
                adminIndex: "{{ url_for('admin.index') }}",
                adminBadges: "{{ url_for('admin.badges') }}"
            }
        };
    </script>

    <!-- Load component scripts -->
    <script type="text/babel" src="{{ url_for('main.serve_component', filename='Header.jsx') }}"></script>
    <script type="text/babel" src="{{ url_for('main.serve_component', filename='Footer.jsx') }}"></script>
    <script type="text/babel" src="{{ url_for('main.serve_component', filename='AdminSidebar.jsx') }}"></script>

    <script type="text/babel">
        {% raw %}
        const EmojiPicker = ({ onSelect, selectedEmoji }) => {
            const [emojis, setEmojis] = React.useState([]);
            const [filteredEmojis, setFilteredEmojis] = React.useState([]);
            const [categories, setCategories] = React.useState([]);
            const [activeCategory, setActiveCategory] = React.useState('all');
            const [searchQuery, setSearchQuery] = React.useState('');
            const [loading, setLoading] = React.useState(true);

            // Temel emojiler (API yanÄ±t vermezse bunlar gÃ¶sterilir)
            const fallbackEmojis = [
                'ðŸ†', 'ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', 'ðŸŽ–ï¸', 'â­', 'ðŸŒŸ', 'âœ¨', 'ðŸ’«', 'ðŸ”¥',
                'ðŸ’¡', 'ðŸ“š', 'ðŸ‘¨â€ðŸŽ“', 'ðŸ‘©â€ðŸŽ“', 'ðŸ§ ', 'ðŸš€', 'ðŸ’»', 'âš¡', 'ðŸŽ¯', 'ðŸ…',
                'ðŸ', 'ðŸ˜', 'ðŸ¦Š', 'ðŸ¦', 'ðŸ¦„', 'ðŸ¢', 'ðŸ¦”', 'ðŸ¦‰', 'ðŸ§©', 'ðŸŽ“',
                'ðŸŽ®', 'ðŸŽ²', 'ðŸŽ¨', 'ðŸŽ­', 'ðŸŽ¬', 'ðŸ’Ž', 'ðŸŽª', 'ðŸ“Š', 'ðŸ“ˆ', 'ðŸ› ï¸',
                'ðŸ‘', 'ðŸ‘‘', 'ðŸ”', 'ðŸ“±', 'ðŸ’¼', 'ðŸ“', 'ðŸ§©', 'ðŸ§ª', 'ðŸ”¬', 'ðŸ§®',
                'ðŸ“Š', 'ðŸ“ˆ', 'ðŸ“‰', 'ðŸ’¯', 'ðŸ“‹', 'âœ…', 'âœ“', 'â˜‘ï¸', 'ðŸ“Œ', 'âš™ï¸'
            ];

            // API'den emojileri yÃ¼kle veya hazÄ±r bir emoji JSON dosyasÄ± kullan
            // React.useEffect iÃ§indeki kÄ±smÄ± ÅŸÃ¶yle deÄŸiÅŸtirin
            React.useEffect(() => {
                const fetchEmojis = async () => {
                    try {
                        setLoading(true);

                        // EmojiHub API'sini kullan
                        const response = await fetch('https://emojihub.yurace.pro/api/all');

                        if (!response.ok) {
                            throw new Error('Emoji verisi yÃ¼klenemedi');
                        }

                        const data = await response.json();

                        // HTML kod dÃ¶nÃ¼ÅŸÃ¼mÃ¼ iÃ§in yardÄ±mcÄ± fonksiyon
                        const htmlToEmoji = (html) => {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = html;
                            return tempDiv.innerText || '?';
                        };

                        // API yanÄ±t formatÄ±na gÃ¶re dÃ¶nÃ¼ÅŸÃ¼m yapma
                        const emojiData = data.map(emoji => ({
                            emoji: htmlToEmoji(emoji.htmlCode[0]),
                            name: emoji.name,
                            category: emoji.category || emoji.group || 'Genel'
                        }));

                        setEmojis(emojiData);
                        setFilteredEmojis(emojiData);

                        // Kategorileri Ã§Ä±kar ve sÄ±rala
                        const uniqueCategories = ['TÃ¼mÃ¼', ...new Set(emojiData.map(e => e.category))].sort();
                        setCategories(uniqueCategories);

                    } catch (error) {
                        console.error('Emoji veri yÃ¼klemesi baÅŸarÄ±sÄ±z:', error);
                        setupFallbackEmojis();
                    } finally {
                        setLoading(false);
                    }
                };

                const setupFallbackEmojis = () => {
                    // Fallback emoji kategorileri
                    const categories = {
                        'Ã–dÃ¼ller': ['ðŸ†', 'ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', 'ðŸŽ–ï¸', 'ðŸ…', 'ðŸŽ¯'],
                        'YÄ±ldÄ±zlar': ['â­', 'ðŸŒŸ', 'âœ¨', 'ðŸ’«', 'ðŸ”¥', 'âš¡'],
                        'EÄŸitim': ['ðŸ“š', 'ðŸ‘¨â€ðŸŽ“', 'ðŸ‘©â€ðŸŽ“', 'ðŸ§ ', 'ðŸŽ“', 'ðŸ“', 'ðŸ§®'],
                        'Teknoloji': ['ðŸš€', 'ðŸ’»', 'ðŸ“±', 'âš™ï¸', 'ðŸ”', 'ðŸ› ï¸'],
                        'Hayvanlar': ['ðŸ', 'ðŸ˜', 'ðŸ¦Š', 'ðŸ¦', 'ðŸ¦„', 'ðŸ¢', 'ðŸ¦”', 'ðŸ¦‰'],
                        'Oyun': ['ðŸŽ®', 'ðŸŽ²', 'ðŸ§©'],
                        'Sanat': ['ðŸŽ¨', 'ðŸŽ­', 'ðŸŽ¬', 'ðŸŽª'],
                        'Ä°ÅŸ': ['ðŸ’¼', 'ðŸ“Š', 'ðŸ“ˆ', 'ðŸ“‰', 'ðŸ’¯', 'ðŸ“‹', 'âœ…', 'âœ“'],
                        'DiÄŸer': ['ðŸ’¡', 'ðŸ’Ž', 'ðŸ‘', 'ðŸ‘‘', 'ðŸ“Œ', 'â˜‘ï¸', 'ðŸ§ª', 'ðŸ”¬']
                    };

                    const cats = Object.keys(categories);
                    const allEmojis = [];

                    cats.forEach(category => {
                        categories[category].forEach(emoji => {
                            allEmojis.push({
                                emoji: emoji,
                                name: emoji,
                                category: category
                            });
                        });
                    });

                    setCategories(['TÃ¼mÃ¼', ...cats]);
                    setEmojis(allEmojis);
                    setFilteredEmojis(allEmojis);
                };

                // API Ã§aÄŸrÄ±sÄ±nÄ± yap
                fetchEmojis();

            }, []);

            // Arama ve kategori filtrelemesi
            React.useEffect(() => {
                let result = [...emojis];

                // Kategori filtrelemesi
                if (activeCategory !== 'TÃ¼mÃ¼' && activeCategory !== 'all') {
                    result = result.filter(e => e.category === activeCategory);
                }

                // Arama filtrelemesi
                if (searchQuery) {
                    const lowerQuery = searchQuery.toLowerCase();
                    result = result.filter(e =>
                        e.name.toLowerCase().includes(lowerQuery) ||
                        e.category.toLowerCase().includes(lowerQuery)
                    );
                }

                setFilteredEmojis(result);
            }, [searchQuery, activeCategory, emojis]);

            return (
                <div className="emoji-picker mt-2">
                    <div className="flex items-center mb-2">
                        <input
                            type="text"
                            placeholder="Emoji ara..."
                            className="flex-1 p-2 border border-gray-300 rounded-md"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>

                    <div className="emoji-categories">
                        {categories.map(category => (
                            <button
                                key={category}
                                className={`emoji-category px-3 py-1 text-sm rounded-md ${activeCategory === category ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}
                                onClick={() => setActiveCategory(category)}
                            >
                                {category}
                            </button>
                        ))}
                    </div>

                    {loading ? (
                        <div className="p-4 text-center">
                            <div className="inline-block animate-spin rounded-full h-6 w-6 border-4 border-gray-300 border-t-blue-600"></div>
                            <p className="mt-1 text-gray-500">Emojiler yÃ¼kleniyor...</p>
                        </div>
                    ) : (
                        <div className="p-3 border border-gray-300 rounded-md emoji-list">
                            {filteredEmojis.length > 0 ? (
                                filteredEmojis.map((item, index) => (
                                    <button
                                        key={index}
                                        type="button"
                                        onClick={() => onSelect(item.emoji)}
                                        className={`p-2 rounded-md flex items-center justify-center ${selectedEmoji === item.emoji ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                                        title={item.name}
                                    >
                                        <span className="emoji">{item.emoji}</span>
                                    </button>
                                ))
                            ) : (
                                <p className="p-2 text-center text-gray-500">EÅŸleÅŸen emoji bulunamadÄ±.</p>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const BadgeForm = () => {
            const [selectedEmoji, setSelectedEmoji] = React.useState('ðŸ†');
            const [showEmojiSelector, setShowEmojiSelector] = React.useState(false);
            const [selectedColor, setSelectedColor] = React.useState('#3b82f6');
            const [nameErrors, setNameErrors] = React.useState([]);
            const [descriptionErrors, setDescriptionErrors] = React.useState([]);

            const handleEmojiSelect = (emoji) => {
                setSelectedEmoji(emoji);
                document.getElementById('icon').value = emoji;
                setShowEmojiSelector(false);
            };

            const handleColorChange = (e) => {
                setSelectedColor(e.target.value);
                document.getElementById('color').value = e.target.value;
            };

            // Form ilk yÃ¼klendiÄŸinde hidden input'larÄ± doldur
            React.useEffect(() => {
                document.getElementById('icon').value = selectedEmoji;
                document.getElementById('color').value = selectedColor;
            }, []);

            return (
                <form method="post" className="bg-white shadow-md rounded-lg p-6">
                    <input type="hidden" name="csrf_token" value={window.APP_DATA.formCsrfToken} />
                    <div className="mb-6">
                        <label htmlFor="name" className="block text-sm font-medium text-gray-700 mb-1">Rozet AdÄ±</label>
                        <input
                            type="text"
                            name="name"
                            id="name"
                            className="w-full p-2 border border-gray-300 rounded-md"
                            required
                        />
                        {nameErrors.map((error, index) => (
                            <p key={index} className="text-sm text-red-600 mt-1">{error}</p>
                        ))}
                    </div>

                    <div className="mb-6">
                        <label htmlFor="description" className="block text-sm font-medium text-gray-700 mb-1">AÃ§Ä±klama</label>
                        <input
                            type="text"
                            name="description"
                            id="description"
                            className="w-full p-2 border border-gray-300 rounded-md"
                            required
                        />
                        {descriptionErrors.map((error, index) => (
                            <p key={index} className="text-sm text-red-600 mt-1">{error}</p>
                        ))}
                    </div>

                    <div className="mb-6">
                        <label htmlFor="icon" className="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                        <div className="flex items-center gap-3">
                            <input type="hidden" name="icon" id="icon" value={selectedEmoji} />

                            <div className="border border-gray-300 rounded-md p-2 flex items-center justify-center w-12 h-12">
                                <span className="emoji-lg">{selectedEmoji}</span>
                            </div>

                            <button
                                type="button"
                                onClick={() => setShowEmojiSelector(!showEmojiSelector)}
                                className="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200"
                            >
                                {showEmojiSelector ? 'Kapat' : 'Emoji SeÃ§'}
                            </button>
                        </div>

                        {showEmojiSelector && (
                            <EmojiPicker
                                onSelect={handleEmojiSelect}
                                selectedEmoji={selectedEmoji}
                            />
                        )}
                    </div>

                    <div className="mb-6">
                        <label htmlFor="color" className="block text-sm font-medium text-gray-700 mb-1">Arka Plan Rengi</label>
                        <div className="flex items-center gap-3">
                            <input type="hidden" name="color" id="color" value={selectedColor} />

                            <input
                                type="color"
                                value={selectedColor}
                                onChange={handleColorChange}
                                className="w-12 h-10 rounded-md cursor-pointer"
                            />
                            <span className="text-sm text-gray-600">{selectedColor}</span>

                            <div className="flex flex-wrap gap-2 ml-4">
                                {['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#71717a'].map(color => (
                                    <button
                                        key={color}
                                        type="button"
                                        className="w-6 h-6 rounded-full border border-gray-300"
                                        style={{backgroundColor: color}}
                                        onClick={() => handleColorChange({target: {value: color}})}
                                    />
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="mb-6">
                        <div className="p-4 border border-gray-300 rounded-md bg-gray-50">
                            <p className="text-sm font-medium text-gray-700 mb-2">Rozet Ã–nizleme</p>
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 rounded-full flex items-center justify-center" style={{backgroundColor: selectedColor}}>
                                    <span className="emoji-lg">{selectedEmoji}</span>
                                </div>
                                <div>
                                    <p className="font-medium" id="namePreview">Rozet AdÄ±</p>
                                    <p className="text-sm text-gray-600" id="descPreview">Rozet aÃ§Ä±klamasÄ± burada gÃ¶sterilir</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-end space-x-3">
                        <a href={window.APP_DATA.urls.adminBadges} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">
                            Ä°ptal
                        </a>
                        <button
                            type="submit"
                            className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700"
                        >
                            Rozeti Kaydet
                        </button>
                    </div>
                </form>
            );
        };

        const App = () => {
            const translations = {
                badges: window.APP_DATA.headerTrans.badges || "Rozetler",
                new_badge: "Yeni Rozet",
                dashboard: "Dashboard"
            };

            React.useEffect(() => {
                const nameInput = document.getElementById('name');
                const descInput = document.getElementById('description');

                if (nameInput) {
                    nameInput.addEventListener('input', (e) => {
                        document.getElementById('namePreview').textContent = e.target.value || "Rozet AdÄ±";
                    });
                }

                if (descInput) {
                    descInput.addEventListener('input', (e) => {
                        document.getElementById('descPreview').textContent = e.target.value || "Rozet aÃ§Ä±klamasÄ± burada gÃ¶sterilir";
                    });
                }
            }, []);

            return (
                <React.Fragment>
                    <Header />
                    <div className="flex flex-grow">
                        <AdminSidebar />
                        <main className="flex-grow p-6">
                            <div className="container mx-auto max-w-8xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h1 className="text-2xl font-bold">{translations.new_badge}</h1>
                                    <nav className="text-sm" aria-label="Breadcrumb">
                                        <ol className="flex space-x-2">
                                            <li><a href={window.APP_DATA.urls.adminIndex} className="text-blue-600 hover:text-blue-800">{translations.dashboard}</a></li>
                                            <li>/</li>
                                            <li><a href={window.APP_DATA.urls.adminBadges} className="text-blue-600 hover:text-blue-800">{translations.badges}</a></li>
                                            <li>/</li>
                                            <li className="text-gray-700">{translations.new_badge}</li>
                                        </ol>
                                    </nav>
                                </div>
                                <BadgeForm />
                            </div>
                        </main>
                    </div>
                    <Footer />
                </React.Fragment>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
        {% endraw %}
    </script>

    <!-- Flash mesajlarÄ± iÃ§in script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    const container = document.querySelector('.container');
                    const formElement = document.querySelector('form');

                    {% for category, message in messages %}
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `p-4 mb-4 rounded-lg ${category === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                        messageDiv.textContent = '{{ message }}';
                        container.insertBefore(messageDiv, formElement);
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>
</body>
</html>